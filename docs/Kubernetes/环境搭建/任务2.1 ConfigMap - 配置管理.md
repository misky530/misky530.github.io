## 任务2.1: ConfigMap - 配置管理

ConfigMap用于将配置数据与容器镜像解耦，避免硬编码配置。

### 创建ConfigMap

bash

```bash
# 方法1: 从字面值创建
kubectl create configmap app-config \
  --from-literal=database.url="postgresql://db:5432/mydb" \
  --from-literal=log.level="INFO" \
  --from-literal=app.name="MyApp"

# 查看ConfigMap
kubectl get configmap
kubectl describe configmap app-config

# 方法2: 从文件创建
cat > app.properties << 'EOF'
app.name=MyApp
app.version=1.0
app.environment=development
database.host=mysql
database.port=3306
EOF

kubectl create configmap app-file-config --from-file=app.properties

# 查看内容
kubectl get configmap app-file-config -o yaml
```

### 使用ConfigMap

创建Pod使用ConfigMap：

yaml

```yaml
cat > pod-with-configmap.yaml << 'EOF'
apiVersion: v1
kind: Pod
metadata:
  name: app-with-config
spec:
  containers:
  - name: app
    image: busybox
    command: ["/bin/sh", "-c"]
    args:
    - |
      echo "=== Environment Variables ==="
      echo "Database URL: $DB_URL"
      echo "Log Level: $LOG_LEVEL"
      echo ""
      echo "=== Config File ==="
      cat /config/app.properties
      echo ""
      echo "Sleeping for 1 hour..."
      sleep 3600
    # 方式1: 环境变量
    env:
    - name: DB_URL
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: database.url
    - name: LOG_LEVEL
      valueFrom:
        configMapKeyRef:
          name: app-config
          key: log.level
    # 方式2: 挂载为文件
    volumeMounts:
    - name: config-volume
      mountPath: /config
  volumes:
  - name: config-volume
    configMap:
      name: app-file-config
EOF

kubectl apply -f pod-with-configmap.yaml
```

### 验证配置注入

bash

```bash
# 查看Pod日志
kubectl logs app-with-config

# 应该看到：
# === Environment Variables ===
# Database URL: postgresql://db:5432/mydb
# Log Level: INFO
# 
# === Config File ===
# app.name=MyApp
# app.version=1.0
# ...

# 进入容器验证
kubectl exec -it app-with-config -- sh
# 在容器内:
# echo $DB_URL
# cat /config/app.properties
# exit
```

### 更新ConfigMap

bash

```bash
# 更新配置
kubectl create configmap app-config \
  --from-literal=database.url="postgresql://db:5432/mydb" \
  --from-literal=log.level="DEBUG" \
  --from-literal=app.name="MyApp" \
  --dry-run=client -o yaml | kubectl apply -f -

# 注意: Pod需要重启才能读取新配置
kubectl delete pod app-with-config
kubectl apply -f pod-with-configmap.yaml

# 查看新日志
kubectl logs app-with-config
```

### 清理

bash

```bash
kubectl delete pod app-with-config
kubectl delete configmap app-config app-file-config
rm app.properties pod-with-configmap.yaml
```

------

现在开始做这个任务，完成后告诉我结果。然后我们继续任务2.2 Secret的学习。

在K9s中可以输入 `:configmap` 查看所有ConfigMap，选中后按 `d` 查看详情，按 `y` 查看YAML。