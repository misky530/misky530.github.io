# ingress-系统在高并发时响应变慢

```
假设您现在负责解决一个客户反馈的 “系统在高并发时响应变慢” 的问题，通过监控发现 Ingress-Nginx 的 TCP 连接数和 CPU 利用率都很高。


您会优先检查 Ingress-Nginx 的哪一项配置？

您会如何基于您的经验（或查阅资料）来具体调整这个参数，以缓解高并发压力？
```

### 网络与 Ingress 性能优化指导

当监控显示 **Ingress-Nginx 的 TCP 连接数和 CPU 利用率都很高**时，这通常意味着 **Nginx Worker 进程**正在忙于处理大量的并发连接，并且可能存在 **I/O 等待**或**上下文切换**导致的性能瓶颈。

**优先检查的配置项：**

我会优先检查 **Nginx Worker 进程数** (`worker_processes`)。

- **原因：** Nginx 采用 Master-Worker 模型。如果 Worker 进程数设置不当（例如默认值 1 或 2），在高并发场景下，少量 Worker 进程将无法充分利用服务器的多核 CPU 能力，导致大量请求被队列等待，从而造成整体响应变慢和 CPU 利用率飙升（大部分是系统态的 CPU 消耗）。

**具体的调整和缓解策略：**

我将从两个关键层面进行调整：

#### 1. 调整 Worker 进程数（核心解决 CPU 瓶颈）

- **调整目标：** 使 Worker 进程数与 Ingress 节点（Pod 所在节点）的 CPU **核心数相匹配**，最大化多核并行处理能力。
- **配置修改：**
  - 在 Ingress-Nginx 的配置中（通常是通过 `ConfigMap` 或定制的 `IngressController` 参数）： 将 `worker_processes` 设置为 `auto` 或具体的核心数。 *例如：* 如果节点有 8 个 CPU 核心，设置为 `worker_processes 8;` 或 `worker_processes auto;`。
- **预期效果：** 调整后，大量并发请求可以被分散到更多的 Worker 进程中并行处理，有效降低单个进程的压力，提高整体吞吐量和 CPU 利用效率。

#### 2. 优化连接和缓冲区（缓解 I/O 和连接压力）

同时，为了支持更高的并发连接数，我会检查并优化以下两个参数：

| 参数                     | 目标               | 调整依据                                                     | 预期效果                                                     |
| ------------------------ | ------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **`worker_connections`** | **最大并发连接数** | 提升每个 Worker 进程能处理的最大连接数，这个值应足够大（例如 4096、8192 或更高）。 | 允许 Nginx 承载更多的并发请求，避免因连接数限制而拒绝新的连接。 |
| **`keepalive_timeout`**  | **长连接超时时间** | 适当调低，例如从 75s 降低到 **30s** 左右。                   | 减少空闲的长连接对系统资源的占用，更快地释放资源，服务给新的请求。 |

导出到 Google 表格

**总结：** 解决 Ingress-Nginx 高并发瓶颈的核心在于调整 **`worker_processes`** 以匹配 CPU 资源，并配合 **`worker_connections`** 和 **`keepalive_timeout`** 的优化，来全面提升系统的并发处理能力和资源利用率。